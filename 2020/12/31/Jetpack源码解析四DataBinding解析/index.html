<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Jetpack源码解析（四）之Data Binding | Yangim's Blog</title><meta name="description" content="Jetpack源码解析四之Data BindingData Binding(数据绑定库)是一种支持库，借助该库，您可以使用声明性格式（而非程序化地）将布局中的界面组件绑定到应用中的数据源。 所谓声明式UI，就是你在代码中做出的任何改变，都会实时的在界面中展示出来。与之对应的是命令式UI，当你想要改变界面时，必须调用XX.setText()之类的代码，才能使界面做出改变。 声明式&#x2F;命令式用传统的命令"><meta name="author" content="@caoyangim"><meta name="copyright" content="@caoyangim"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://caoyangim.github.io/2020/12/31/Jetpack%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E5%9B%9BDataBinding%E8%A7%A3%E6%9E%90/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="Jetpack源码解析（四）之Data Binding"><meta property="og:url" content="https://caoyangim.github.io/2020/12/31/Jetpack%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E5%9B%9BDataBinding%E8%A7%A3%E6%9E%90/"><meta property="og:site_name" content="Yangim's Blog"><meta property="og:description" content="Jetpack源码解析四之Data BindingData Binding(数据绑定库)是一种支持库，借助该库，您可以使用声明性格式（而非程序化地）将布局中的界面组件绑定到应用中的数据源。 所谓声明式UI，就是你在代码中做出的任何改变，都会实时的在界面中展示出来。与之对应的是命令式UI，当你想要改变界面时，必须调用XX.setText()之类的代码，才能使界面做出改变。 声明式&#x2F;命令式用传统的命令"><meta property="og:image" content="https://caoyangim.github.io/2020/12/31/Jetpack%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E5%9B%9BDataBinding%E8%A7%A3%E6%9E%90/image-20210103190946285.png"><meta property="article:published_time" content="2020-12-31T12:00:12.388Z"><meta property="article:modified_time" content="2021-02-17T13:13:59.882Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.1.1',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: undefined,
  ClickShowText: {"text":"I,LOVE,YOU,枯藤,老树,昏鸦,小桥,流水,人家,古道,西风,瘦马,夕阳西下,断肠人,在天涯","fontSize":"15px"},
  medium_zoom: true,
  fancybox: false,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: false,
  islazyload: true,
  isanchor: false    
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2021-02-17 21:13:59'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 5.1.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" data-lazy-src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">45</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">15</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div id="body-wrap"><div id="web_bg" data-type="color"></div><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Jetpack%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E5%9B%9B%E4%B9%8BData-Binding"><span class="toc-number">1.</span> <span class="toc-text">Jetpack源码解析四之Data Binding</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8F-%E5%91%BD%E4%BB%A4%E5%BC%8F"><span class="toc-number">1.1.</span> <span class="toc-text">声明式&#x2F;命令式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Data-Binding-%E4%BD%BF%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">Data Binding 使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text">原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#activity-main-xml"><span class="toc-number">1.3.1.</span> <span class="toc-text">activity_main.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DataBindingUtil"><span class="toc-number">1.3.2.</span> <span class="toc-text">DataBindingUtil</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DataBinderMapper"><span class="toc-number">1.3.3.</span> <span class="toc-text">DataBinderMapper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#APT-MergedDataBinderMapper"><span class="toc-number">1.3.4.</span> <span class="toc-text">APT-MergedDataBinderMapper</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#APT-ActivityMainBindingImpl"><span class="toc-number">1.3.5.</span> <span class="toc-text">APT-ActivityMainBindingImpl</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mapBindings"><span class="toc-number">1.3.5.1.</span> <span class="toc-text">mapBindings</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#APT-setMsg"><span class="toc-number">1.3.6.</span> <span class="toc-text">APT-setMsg()</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CallbackRegistry-notifyCallbacks"><span class="toc-number">1.3.6.1.</span> <span class="toc-text">CallbackRegistry.notifyCallbacks()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PropertyChangeRegistry-NotifierCallback-onNotifyCallback"><span class="toc-number">1.3.6.2.</span> <span class="toc-text">PropertyChangeRegistry.NotifierCallback.onNotifyCallback</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ViewBinding-onPropertyChanged"><span class="toc-number">1.3.6.3.</span> <span class="toc-text">ViewBinding.onPropertyChanged</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(/2020/12/31/Jetpack%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E5%9B%9BDataBinding%E8%A7%A3%E6%9E%90/image-20210103190946285.png)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">Yangim's Blog</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 娱乐</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fas fa-music"></i><span> 音乐</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 电影</span></a></li><li><a class="site-page" href="/books/"><i class="fa-fw fas fa-book"></i><span> 书籍</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 链接</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Jetpack源码解析（四）之Data Binding</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-12-31T12:00:12.388Z" title="发表于 2020-12-31 20:00:12">2020-12-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-02-17T13:13:59.882Z" title="更新于 2021-02-17 21:13:59">2021-02-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Android-Jetpack/">Android Jetpack</a></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="Jetpack源码解析四之Data-Binding"><a href="#Jetpack源码解析四之Data-Binding" class="headerlink" title="Jetpack源码解析四之Data Binding"></a>Jetpack源码解析四之Data Binding</h1><p>Data Binding(数据绑定库)是一种支持库，借助该库，您可以使用<strong>声明性格式</strong>（而非程序化地）将布局中的界面组件绑定到应用中的数据源。</p>
<p>所谓声明式UI，就是你在代码中做出的任何改变，都会实时的在界面中展示出来。与之对应的是命令式UI，当你想要改变界面时，必须调用XX.setText()之类的代码，才能使界面做出改变。</p>
<h2 id="声明式-命令式"><a href="#声明式-命令式" class="headerlink" title="声明式/命令式"></a>声明式/命令式</h2><p>用传统的命令式UI，当要改变数据时，要如下操作：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">findViewById&lt;TextView&gt;(R.id.sample_text).apply &#123;</span><br><span class="line">    text = viewModel.userName</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>而用数据绑定后，只需在xml中声明如下，无需任何逻辑代码，当username变化时，组件自动发生变化。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;@&#123;viewmodel.userName&#125;&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>Data Binding并不仅仅是为了取代<code>findViewById()</code>。如果你的主要目的是取代 <code>findViewById()</code> 调用，请考虑改用<a target="_blank" rel="noopener" href="https://developer.android.com/topic/libraries/view-binding">视图绑定</a>【View Binding】 或者 直接用Kotlin。</p>
</blockquote>
<h2 id="Data-Binding-使用"><a href="#Data-Binding-使用" class="headerlink" title="Data Binding 使用"></a>Data Binding 使用</h2><p>当然，如果直接在界面上这样写是没用的，得配置下。app:build.gradle中开启：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dataBinding &#123;</span><br><span class="line">    enabled = <span class="keyword">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>xml界面更改为如下样式即可：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;msg&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;String&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/text&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">&quot;@&#123;msg,default = `Hello World`&#125;&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在Activity界面中获取binding，直接操作即可：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        <span class="keyword">val</span> binding: ActivityMainBinding = DataBindingUtil.setContentView(</span><br><span class="line">            <span class="keyword">this</span>, R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">        Thread&#123;</span><br><span class="line">            <span class="keyword">var</span> i = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>)&#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>)</span><br><span class="line">                <span class="comment">//听说异步线程不能更新UI？sorry，我可以。因为我只改变了值，没有调用`更新UI`代码~</span></span><br><span class="line">                binding.msg = i++.toString()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.start()</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>主要是用到了APT（Annotation Processing Tool/注解处理工具）技术。在编译时对注解进行解析，自动生成代码，并编译代码生成class文件。</p>
<p>在项目的 build 目录下，可以看到生成的代码文件：</p>
<table>
<thead>
<tr>
<th align="center">build/generated/source</th>
<th align="center">build/intermediates/data_binding_xx</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><img src= "/img/loading.gif" data-lazy-src="image-20210101133756494.png" alt="image-20210101133756494"></td>
<td align="center"><img src= "/img/loading.gif" data-lazy-src="image-20210101134221268.png" alt="image-20210101134221268"></td>
</tr>
</tbody></table>
<hr>
<p>先看我们自己写的xml文件。像这种layout标签，不开启dataBinding的情况下编译器是铁定不识别的。所以我们有理由相信dataBinding后面肯定是将这个xml文件处理成了传统的xml布局格式。在build/intermediates/incremental/mergeDebugResources/stripped.dir/layout目录下，可以找到一个activity_main.xml文件，这个文件就是处理完后的xml文件了。</p>
<h3 id="activity-main-xml"><a href="#activity-main-xml" class="headerlink" title="activity_main.xml"></a>activity_main.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:context</span>=<span class="string">&quot;.MainActivity&quot;</span> <span class="attr">android:tag</span>=<span class="string">&quot;layout/activity_main_0&quot;</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span> <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span> <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:id</span>=<span class="string">&quot;@+id/text&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:text</span>=<span class="string">&quot;Hello World&quot;</span>                   </span></span><br><span class="line"><span class="tag">              <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span>  <span class="attr">android:tag</span>=<span class="string">&quot;binding_1&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br><span class="line">         </span><br></pre></td></tr></table></figure>

<p>这个文件和我们自己写的布局文件后半部分很像，就只有一点不一样：在有用到dataBinding的地方，多了个<strong>tag标签</strong>–<code>android:tag=&quot;binding_1&quot;</code>。那前半部分<data>标签去哪了呢？在第二张截图所展示目录下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; standalone=&quot;yes&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Layout</span> <span class="attr">layout</span>=<span class="string">&quot;activity_main&quot;</span> <span class="attr">modulePackage</span>=<span class="string">&quot;com.cy.myapplication&quot;</span> <span class="attr">filePath</span>=<span class="string">&quot;app\src\main\res\layout\activity_main.xml&quot;</span> <span class="attr">directory</span>=<span class="string">&quot;layout&quot;</span> <span class="attr">isMerge</span>=<span class="string">&quot;false&quot;</span> <span class="attr">isBindingData</span>=<span class="string">&quot;true&quot;</span> <span class="attr">rootNodeType</span>=<span class="string">&quot;androidx.constraintlayout.widget.ConstraintLayout&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Variables</span> <span class="attr">declared</span>=<span class="string">&quot;true&quot;</span> <span class="attr">type</span>=<span class="string">&quot;String&quot;</span> <span class="attr">name</span>=<span class="string">&quot;msg&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">location</span> <span class="attr">startLine</span>=<span class="string">&quot;6&quot;</span> <span class="attr">startOffset</span>=<span class="string">&quot;8&quot;</span> <span class="attr">endLine</span>=<span class="string">&quot;8&quot;</span> <span class="attr">endOffset</span>=<span class="string">&quot;27&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Variables</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Targets</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Target</span> <span class="attr">tag</span>=<span class="string">&quot;layout/activity_main_0&quot;</span> <span class="attr">view</span>=<span class="string">&quot;androidx.constraintlayout.widget.ConstraintLayout&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Expressions</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">location</span> <span class="attr">startLine</span>=<span class="string">&quot;11&quot;</span> <span class="attr">startOffset</span>=<span class="string">&quot;4&quot;</span> <span class="attr">endLine</span>=<span class="string">&quot;26&quot;</span> <span class="attr">endOffset</span>=<span class="string">&quot;55&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Target</span> <span class="attr">id</span>=<span class="string">&quot;@+id/text&quot;</span> <span class="attr">tag</span>=<span class="string">&quot;binding_1&quot;</span> <span class="attr">view</span>=<span class="string">&quot;TextView&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Expressions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">Expression</span> <span class="attr">text</span>=<span class="string">&quot;msg,default = `Hello World`&quot;</span> <span class="attr">attribute</span>=<span class="string">&quot;android:text&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">Location</span> <span class="attr">startLine</span>=<span class="string">&quot;20&quot;</span> <span class="attr">startOffset</span>=<span class="string">&quot;12&quot;</span> <span class="attr">endLine</span>=<span class="string">&quot;20&quot;</span> <span class="attr">endOffset</span>=<span class="string">&quot;56&quot;</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">TwoWay</span>&gt;</span>false<span class="tag">&lt;/<span class="name">TwoWay</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">ValueLocation</span> <span class="attr">startLine</span>=<span class="string">&quot;20&quot;</span> <span class="attr">startOffset</span>=<span class="string">&quot;28&quot;</span> <span class="attr">endLine</span>=<span class="string">&quot;20&quot;</span> <span class="attr">endOffset</span>=<span class="string">&quot;54&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">Expression</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Expressions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">location</span> <span class="attr">startLine</span>=<span class="string">&quot;16&quot;</span> <span class="attr">startOffset</span>=<span class="string">&quot;8&quot;</span> <span class="attr">endLine</span>=<span class="string">&quot;24&quot;</span> <span class="attr">endOffset</span>=<span class="string">&quot;55&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Target</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Targets</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Layout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过和我们自己写的xml对比着来看，可以看到<variable>中的信息是完全转移到了这个xml中的；原布局文件中用到了哪些布局，布局中又引入了哪些variable中的变量，也可以在xml中的Target–Expression下找得到。所以这两份文件可以包含我们所写的xml中的所有信息了。</p>
<h3 id="DataBindingUtil"><a href="#DataBindingUtil" class="headerlink" title="DataBindingUtil"></a>DataBindingUtil</h3><p>再看我们的Java/Kotlin代码。DataBindingUtil.setContentView():</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> DataBindingComponent sDefaultComponent = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends ViewDataBinding&gt; <span class="function">T <span class="title">setContentView</span><span class="params">(<span class="meta">@NonNull</span> Activity activity, <span class="keyword">int</span> layoutId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> setContentView(activity, layoutId, sDefaultComponent);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends ViewDataBinding&gt; <span class="function">T <span class="title">setContentView</span><span class="params">(<span class="meta">@NonNull</span> Activity activity,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                           <span class="keyword">int</span> layoutId, <span class="meta">@Nullable</span> DataBindingComponent bindingComponent)</span> </span>&#123;</span><br><span class="line">    activity.setContentView(layoutId);</span><br><span class="line">    View decorView = activity.getWindow().getDecorView();</span><br><span class="line">    ViewGroup contentView = (ViewGroup) decorView.findViewById(android.R.id.content);</span><br><span class="line">    <span class="keyword">return</span> bindToAddedViews(bindingComponent, contentView, <span class="number">0</span>, layoutId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T extends ViewDataBinding&gt; <span class="function">T <span class="title">bindToAddedViews</span><span class="params">(DataBindingComponent component,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                              ViewGroup parent, <span class="keyword">int</span> startChildren, <span class="keyword">int</span> layoutId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> endChildren = parent.getChildCount();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> childrenAdded = endChildren - startChildren;</span><br><span class="line">    <span class="keyword">if</span> (childrenAdded == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> View childView = parent.getChildAt(endChildren - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> bind(component, childView, layoutId);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> View[] children = <span class="keyword">new</span> View[childrenAdded];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childrenAdded; i++) &#123;</span><br><span class="line">            children[i] = parent.getChildAt(i + startChildren);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bind(component, children, layoutId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先调用<code>activity.setContentView(layoutId);</code>；然后获取decorView中的contentView，将contentView的子view传入bind方法中去【如果多个子view就用数组】。这个contentView中包裹的就是我们自己写的布局，所以第一次进入childCount为1，走第一个方法。  不过后面我还是把传view和传view[]这两个方法代码都贴上来了，注意区分。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> DataBinderMapper sMapper = <span class="keyword">new</span> DataBinderMapperImpl();</span><br><span class="line"><span class="keyword">static</span> &lt;T extends ViewDataBinding&gt; <span class="function">T <span class="title">bind</span><span class="params">(DataBindingComponent bindingComponent, View[] roots,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> layoutId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (T) sMapper.getDataBinder(bindingComponent, roots, layoutId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &lt;T extends ViewDataBinding&gt; <span class="function">T <span class="title">bind</span><span class="params">(DataBindingComponent bindingComponent, View root,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> layoutId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (T) sMapper.getDataBinder(bindingComponent, root, layoutId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>bind方法又转到了sMapper的getDataBinder方法中去。sMapper是个DataBinderMapper对象。</p>
<h3 id="DataBinderMapper"><a href="#DataBinderMapper" class="headerlink" title="DataBinderMapper"></a>DataBinderMapper</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataBinderMapperImpl</span> <span class="keyword">extends</span> <span class="title">MergedDataBinderMapper</span> </span>&#123;</span><br><span class="line">  DataBinderMapperImpl() &#123;</span><br><span class="line">    addMapper(<span class="keyword">new</span> com.cy.myapplication.DataBinderMapperImpl());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MergedDataBinderMapper</span> <span class="keyword">extends</span> <span class="title">DataBinderMapper</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMapper</span><span class="params">(DataBinderMapper mapper)</span> </span>&#123;</span><br><span class="line">        Class&lt;? extends DataBinderMapper&gt; mapperClass = mapper.getClass();</span><br><span class="line">        <span class="keyword">if</span> (mExistingMappers.add(mapperClass)) &#123;</span><br><span class="line">            mMappers.add(mapper);</span><br><span class="line">            <span class="keyword">final</span> List&lt;DataBinderMapper&gt; dependencies = mapper.collectDependencies();</span><br><span class="line">            <span class="keyword">for</span>(DataBinderMapper dependency : dependencies) &#123;</span><br><span class="line">                addMapper(dependency);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>DataBinderMapperImpl</code>继承<code>MergedDataBinderMapper</code>继承<code>DataBinderMapper</code>。<code>DataBinderMapperImpl</code>就一个构造方法，getDataBinder方法的实现在<code>MergedDataBinderMapper</code>中。</p>
<p><code>MergedDataBinderMapper</code>中又持有一个DataBinderMapper的数组：mMappers。该对象在new DataBinderMapperImpl的时候被填充进去数据，这个数据就是APT为我们生成的类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MergedDataBinderMapper</span> <span class="keyword">extends</span> <span class="title">DataBinderMapper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;DataBinderMapper&gt; mMappers = <span class="keyword">new</span> CopyOnWriteArrayList&lt;&gt;();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewDataBinding <span class="title">getDataBinder</span><span class="params">(DataBindingComponent bindingComponent, View view,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> layoutId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(DataBinderMapper mapper : mMappers) &#123;</span><br><span class="line">            ViewDataBinding result = mapper.getDataBinder(bindingComponent, view, layoutId);</span><br><span class="line">            <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (loadFeatures()) &#123;</span><br><span class="line">            <span class="keyword">return</span> getDataBinder(bindingComponent, view, layoutId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ViewDataBinding <span class="title">getDataBinder</span><span class="params">(DataBindingComponent bindingComponent, View[] view,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> layoutId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(DataBinderMapper mapper : mMappers) &#123;</span><br><span class="line">            ViewDataBinding result = mapper.getDataBinder(bindingComponent, view, layoutId);</span><br><span class="line">            <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> result;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (loadFeatures()) &#123;</span><br><span class="line">            <span class="keyword">return</span> getDataBinder(bindingComponent, view, layoutId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以不出所料的，MergedDataBinderMapper中的getDataBinder方法最终转交给了APT生成的Mapper中的getDataBinder。</p>
<h3 id="APT-MergedDataBinderMapper"><a href="#APT-MergedDataBinderMapper" class="headerlink" title="APT-MergedDataBinderMapper"></a>APT-MergedDataBinderMapper</h3><p>所以来到APT生成的MergedDataBinderMapper中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//setContentView(activity, layoutId, sDefaultComponent);</span></span><br><span class="line"><span class="comment">//bindToAddedViews(bindingComponent, contentView, 0, layoutId);</span></span><br><span class="line"><span class="comment">//bind(component, contentView‘s children, layoutId);</span></span><br><span class="line"><span class="comment">//上面是之前一路走来的用到的方法，写这里免得大家忘了。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SparseIntArray INTERNAL_LAYOUT_ID_LOOKUP = <span class="keyword">new</span> SparseIntArray(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    INTERNAL_LAYOUT_ID_LOOKUP.put(com.cy.myapplication.R.layout.activity_main, LAYOUT_ACTIVITYMAIN);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ViewDataBinding <span class="title">getDataBinder</span><span class="params">(DataBindingComponent component, View view, <span class="keyword">int</span> layoutId)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> localizedLayoutId = INTERNAL_LAYOUT_ID_LOOKUP.get(layoutId);</span><br><span class="line">  <span class="keyword">if</span>(localizedLayoutId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">final</span> Object tag = view.getTag();</span><br><span class="line">    <span class="keyword">if</span>(tag == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;view must have a tag&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span>(localizedLayoutId) &#123;</span><br><span class="line">      <span class="keyword">case</span>  LAYOUT_ACTIVITYMAIN: &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;layout/activity_main_0&quot;</span>.equals(tag)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">new</span> ActivityMainBindingImpl(component, view);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;The tag for activity_main is invalid. Received: &quot;</span> + tag);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ViewDataBinding <span class="title">getDataBinder</span><span class="params">(DataBindingComponent component, View[] views, <span class="keyword">int</span> layoutId)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(views == <span class="keyword">null</span> || views.length == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> localizedLayoutId = INTERNAL_LAYOUT_ID_LOOKUP.get(layoutId);</span><br><span class="line">  <span class="keyword">if</span>(localizedLayoutId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">final</span> Object tag = views[<span class="number">0</span>].getTag();</span><br><span class="line">    <span class="keyword">if</span>(tag == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;view must have a tag&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span>(localizedLayoutId) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到这里第一次进入传来的view就是带Tag的activity_main.xml，所以tag能对的上，返回的就是ActivityMainBindingImpl(component, view);</p>
<p>对了，到这的时候，component = null,view是Activity_main中的最外层view。</p>
<h3 id="APT-ActivityMainBindingImpl"><a href="#APT-ActivityMainBindingImpl" class="headerlink" title="APT-ActivityMainBindingImpl"></a>APT-ActivityMainBindingImpl</h3><p>首先，这个类也是APT帮我们生成的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> androidx.databinding.ViewDataBinding.IncludedLayouts sIncludes;</span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> android.util.SparseIntArray sViewsWithIds;</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    sIncludes = <span class="keyword">null</span>;</span><br><span class="line">    sViewsWithIds = <span class="keyword">null</span>;</span><br><span class="line">&#125;<span class="comment">//上面是要用到的数据</span></span><br><span class="line"><span class="comment">//下面是构造方法</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActivityMainBindingImpl</span><span class="params">(<span class="meta">@Nullable</span> androidx.databinding.DataBindingComponent bindingComponent, <span class="meta">@NonNull</span> View root)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>(bindingComponent, root, mapBindings(bindingComponent, root, <span class="number">2</span>, sIncludes, sViewsWithIds));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">ActivityMainBindingImpl</span><span class="params">(androidx.databinding.DataBindingComponent bindingComponent, View root, Object[] bindings)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(bindingComponent, root, <span class="number">0</span></span><br><span class="line">          , (android.widget.TextView) bindings[<span class="number">1</span>]</span><br><span class="line">         );</span><br><span class="line">    <span class="keyword">this</span>.mboundView0 = (androidx.constraintlayout.widget.ConstraintLayout) bindings[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">this</span>.mboundView0.setTag(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">this</span>.text.setTag(<span class="keyword">null</span>);</span><br><span class="line">    setRootTag(root);</span><br><span class="line">    <span class="comment">// listeners</span></span><br><span class="line">    invalidateAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="mapBindings"><a href="#mapBindings" class="headerlink" title="mapBindings"></a>mapBindings</h4><p>这里用到了一个方法生成Object[]:由于mapBinding方法略长，所以没打算贴出来。</p>
<p>这个方法相当于是对我们传入的这个view进行一次解析，解析完成后返回的Object[]数组里面包含的就是这个view中所有的view对象。</p>
<p><img src= "/img/loading.gif" data-lazy-src="image-20210101210706060.png" alt="image-20210101210706060"></p>
<p>然后在初始化方法中setTag中将数组中的对象打上标签tag并存起来。比如this.text就是我们布局文件中的textView,其id叫<code>text</code>。所以我们能通过binding.text获得该控件。</p>
<h3 id="APT-setMsg"><a href="#APT-setMsg" class="headerlink" title="APT-setMsg()"></a>APT-setMsg()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMsg</span><span class="params">(<span class="meta">@Nullable</span> java.lang.String Msg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.mMsg = Msg;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        mDirtyFlags |= <span class="number">0x1L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    notifyPropertyChanged(BR.msg);</span><br><span class="line">    <span class="keyword">super</span>.requestRebind();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span>  <span class="keyword">long</span> mDirtyFlags = <span class="number">0xffffffffffffffffL</span>;</span><br><span class="line"><span class="comment">/* flag mapping</span></span><br><span class="line"><span class="comment">   flag 0 (0x1L): msg</span></span><br><span class="line"><span class="comment">   flag 1 (0x2L): null</span></span><br><span class="line"><span class="comment">flag mapping end*/</span></span><br></pre></td></tr></table></figure>

<p>这个mDirtyFlags值是后面用作判断修改哪个值用的。然后跟着notifyPropertyChanged()方法;</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notifyPropertyChanged</span><span class="params">(<span class="keyword">int</span> fieldId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mCallbacks == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mCallbacks.notifyCallbacks(<span class="keyword">this</span>, fieldId, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="CallbackRegistry-notifyCallbacks"><a href="#CallbackRegistry-notifyCallbacks" class="headerlink" title="CallbackRegistry.notifyCallbacks()"></a>CallbackRegistry.notifyCallbacks()</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">notifyCallbacks</span><span class="params">(T sender, <span class="keyword">int</span> arg, A arg2)</span> </span>&#123;</span><br><span class="line">    mNotificationLevel++;</span><br><span class="line">    <span class="comment">//--------------------------主要看这个方法----------</span></span><br><span class="line">    notifyRecurse(sender, arg, arg2);</span><br><span class="line">    mNotificationLevel--;</span><br><span class="line">    <span class="keyword">if</span> (mNotificationLevel == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (mRemainderRemoved != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = mRemainderRemoved.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">long</span> removedBits = mRemainderRemoved[i];</span><br><span class="line">                <span class="keyword">if</span> (removedBits != <span class="number">0</span>) &#123;</span><br><span class="line">                    removeRemovedCallbacks((i + <span class="number">1</span>) * Long.SIZE, removedBits);</span><br><span class="line">                    mRemainderRemoved[i] = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mFirst64Removed != <span class="number">0</span>) &#123;</span><br><span class="line">            removeRemovedCallbacks(<span class="number">0</span>, mFirst64Removed);</span><br><span class="line">            mFirst64Removed = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyRecurse</span><span class="params">(T sender, <span class="keyword">int</span> arg, A arg2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> callbackCount = mCallbacks.size();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> remainderIndex = mRemainderRemoved == <span class="keyword">null</span> ? -<span class="number">1</span> : mRemainderRemoved.length - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now we&#x27;ve got all callbakcs that have no mRemainderRemoved value, so notify the</span></span><br><span class="line">    <span class="comment">// others.</span></span><br><span class="line">    <span class="comment">//----------------------------看这个方法！！！-------------</span></span><br><span class="line">    notifyRemainder(sender, arg, arg2, remainderIndex);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// notifyRemainder notifies all at maxIndex, so we&#x27;d normally start at maxIndex + 1</span></span><br><span class="line">    <span class="comment">// However, we must also keep track of those in mFirst64Removed, so we add 2 instead:</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> startCallbackIndex = (remainderIndex + <span class="number">2</span>) * Long.SIZE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The remaining have no bit set</span></span><br><span class="line">    notifyCallbacks(sender, arg, arg2, startCallbackIndex, callbackCount, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyRemainder</span><span class="params">(T sender, <span class="keyword">int</span> arg, A arg2, <span class="keyword">int</span> remainderIndex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (remainderIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//-----------------------走这个！！！！！！！！！--------------------</span></span><br><span class="line">        notifyFirst64(sender, arg, arg2);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> bits = mRemainderRemoved[remainderIndex];</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> startIndex = (remainderIndex + <span class="number">1</span>) * Long.SIZE;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> endIndex = Math.min(mCallbacks.size(), startIndex + Long.SIZE);</span><br><span class="line">        notifyRemainder(sender, arg, arg2, remainderIndex - <span class="number">1</span>);</span><br><span class="line">        notifyCallbacks(sender, arg, arg2, startIndex, endIndex, bits);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyFirst64</span><span class="params">(T sender, <span class="keyword">int</span> arg, A arg2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> maxNotified = Math.min(Long.SIZE, mCallbacks.size());</span><br><span class="line">    notifyCallbacks(sender, arg, arg2, <span class="number">0</span>, maxNotified, mFirst64Removed);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyCallbacks</span><span class="params">(T sender, <span class="keyword">int</span> arg, A arg2, <span class="keyword">final</span> <span class="keyword">int</span> startIndex,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">final</span> <span class="keyword">int</span> endIndex, <span class="keyword">final</span> <span class="keyword">long</span> bits)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> bitMask = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = startIndex; i &lt; endIndex; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((bits &amp; bitMask) == <span class="number">0</span>) &#123;</span><br><span class="line">            mNotifier.onNotifyCallback(mCallbacks.get(i), sender, arg, arg2);</span><br><span class="line">        &#125;</span><br><span class="line">        bitMask &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="PropertyChangeRegistry-NotifierCallback-onNotifyCallback"><a href="#PropertyChangeRegistry-NotifierCallback-onNotifyCallback" class="headerlink" title="PropertyChangeRegistry.NotifierCallback.onNotifyCallback"></a>PropertyChangeRegistry.NotifierCallback.onNotifyCallback</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> NotifierCallback&lt;OnPropertyChangedCallback, Observable, Void&gt; NOTIFIER_CALLBACK = <span class="keyword">new</span> NotifierCallback&lt;OnPropertyChangedCallback, Observable, Void&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNotifyCallback</span><span class="params">(OnPropertyChangedCallback callback, Observable sender, <span class="keyword">int</span> arg, Void notUsed)</span> </span>&#123;</span><br><span class="line">        callback.onPropertyChanged(sender, arg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="ViewBinding-onPropertyChanged"><a href="#ViewBinding-onPropertyChanged" class="headerlink" title="ViewBinding.onPropertyChanged"></a>ViewBinding.onPropertyChanged</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPropertyChanged</span><span class="params">(Observable sender, <span class="keyword">int</span> propertyId)</span> </span>&#123;</span><br><span class="line">    ViewDataBinding binder = mListener.getBinder();</span><br><span class="line">    <span class="keyword">if</span> (binder == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Observable obj = mListener.getTarget();</span><br><span class="line">    <span class="keyword">if</span> (obj != sender) &#123;</span><br><span class="line">        <span class="keyword">return</span>; <span class="comment">// notification from the wrong object?</span></span><br><span class="line">    &#125;</span><br><span class="line">    binder.handleFieldChange(mListener.mLocalFieldId, sender, propertyId);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleFieldChange</span><span class="params">(<span class="keyword">int</span> mLocalFieldId, Object object, <span class="keyword">int</span> fieldId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mInLiveDataRegisterObserver) &#123;</span><br><span class="line">        <span class="comment">// We&#x27;re in LiveData registration, which always results in a field change</span></span><br><span class="line">        <span class="comment">// that we can ignore. The value will be read immediately after anyway, so</span></span><br><span class="line">        <span class="comment">// there is no need to be dirty.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> result = onFieldChange(mLocalFieldId, object, fieldId);</span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        requestRebind();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里会调用到onFieldChange方法，这个方法实现在imp类中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">onFieldChange</span><span class="params">(<span class="keyword">int</span> localFieldId, Object object, <span class="keyword">int</span> fieldId)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (localFieldId) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回true则认为数据发生了改变，走requestRebind方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">requestRebind</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mContainingBinding != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mContainingBinding.requestRebind();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> LifecycleOwner owner = <span class="keyword">this</span>.mLifecycleOwner;</span><br><span class="line">        <span class="keyword">if</span> (owner != <span class="keyword">null</span>) &#123;</span><br><span class="line">            Lifecycle.State state = owner.getLifecycle().getCurrentState();</span><br><span class="line">            <span class="keyword">if</span> (!state.isAtLeast(Lifecycle.State.STARTED)) &#123;</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// wait until lifecycle owner is started</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mPendingRebind) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            mPendingRebind = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (USE_CHOREOGRAPHER) &#123;</span><br><span class="line">            mChoreographer.postFrameCallback(mFrameCallback);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mUIThreadHandler.post(mRebindRunnable);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后要么走postFrameCallback，要么走mUIThreadHandler.post方法。其实两个方法是一样的，最终都是走的post方法中来，所以这里直接看mRebindRunnable。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable mRebindRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            mPendingRebind = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        processReferenceQueue();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (VERSION.SDK_INT &gt;= VERSION_CODES.KITKAT) &#123;</span><br><span class="line">            <span class="comment">// Nested so that we don&#x27;t get a lint warning in IntelliJ</span></span><br><span class="line">            <span class="keyword">if</span> (!mRoot.isAttachedToWindow()) &#123;</span><br><span class="line">                <span class="comment">// Don&#x27;t execute the pending bindings until the View</span></span><br><span class="line">                <span class="comment">// is attached again.</span></span><br><span class="line">                mRoot.removeOnAttachStateChangeListener(ROOT_REATTACHED_LISTENER);</span><br><span class="line">                mRoot.addOnAttachStateChangeListener(ROOT_REATTACHED_LISTENER);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//执行绑定--------------！</span></span><br><span class="line">        executePendingBindings();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executePendingBindings</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mContainingBinding == <span class="keyword">null</span>) &#123;</span><br><span class="line">        executeBindingsInternal();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mContainingBinding.executePendingBindings();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟着executePendingBindings()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">executeBindingsInternal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mIsExecutingPendingBindings) &#123;</span><br><span class="line">        requestRebind();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!hasPendingBindings()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mIsExecutingPendingBindings = <span class="keyword">true</span>;</span><br><span class="line">    mRebindHalted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (mRebindCallbacks != <span class="keyword">null</span>) &#123;</span><br><span class="line">        mRebindCallbacks.notifyCallbacks(<span class="keyword">this</span>, REBIND, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// The onRebindListeners will change mPendingHalted</span></span><br><span class="line">        <span class="keyword">if</span> (mRebindHalted) &#123;</span><br><span class="line">            mRebindCallbacks.notifyCallbacks(<span class="keyword">this</span>, HALTED, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!mRebindHalted) &#123;</span><br><span class="line">        <span class="comment">//----------------看这里！！！！！！！！！</span></span><br><span class="line">        executeBindings();</span><br><span class="line">        <span class="keyword">if</span> (mRebindCallbacks != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mRebindCallbacks.notifyCallbacks(<span class="keyword">this</span>, REBOUND, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mIsExecutingPendingBindings = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的executeBindings是抽象方法，实现在ActivityMainbindingImpl中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeBindings</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> dirtyFlags = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">        dirtyFlags = mDirtyFlags;</span><br><span class="line">        mDirtyFlags = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    com.cy.myapplication.Girl girl = mGirl;</span><br><span class="line">    java.lang.String girlName = <span class="keyword">null</span>;</span><br><span class="line">    java.lang.String msg = mMsg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((dirtyFlags &amp; <span class="number">0x5L</span>) != <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (girl != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// read girl.name</span></span><br><span class="line">                girlName = girl.getName();</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((dirtyFlags &amp; <span class="number">0x6L</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// batch finished</span></span><br><span class="line">    <span class="keyword">if</span> ((dirtyFlags &amp; <span class="number">0x6L</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// api target 1</span></span><br><span class="line"></span><br><span class="line">        androidx.databinding.adapters.TextViewBindingAdapter.setText(<span class="keyword">this</span>.text, msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((dirtyFlags &amp; <span class="number">0x5L</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// api target 1</span></span><br><span class="line"></span><br><span class="line">        androidx.databinding.adapters.TextViewBindingAdapter.setText(<span class="keyword">this</span>.text2, girlName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到这里便真相大白了。我们所苦苦寻找的更改界面的方法就在这里了。</p>
<p>最后附上一副整体的UML图：</p>
<p><img src= "/img/loading.gif" data-lazy-src="image-20210103190946285.png" alt="image-20210103190946285"></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">@caoyangim</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://caoyangim.github.io/2020/12/31/Jetpack%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E5%9B%9BDataBinding%E8%A7%A3%E6%9E%90/">https://caoyangim.github.io/2020/12/31/Jetpack%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E5%9B%9BDataBinding%E8%A7%A3%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://caoyangim.github.io" target="_blank">Yangim's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/2020/12/31/Jetpack%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E5%9B%9BDataBinding%E8%A7%A3%E6%9E%90/image-20210103190946285.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/01/02/UML%E7%B1%BB%E5%9B%BE/"><img class="prev-cover" data-lazy-src="/2021/01/02/UML%E7%B1%BB%E5%9B%BE/061346324381539.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">UML类图详解</div></div></a></div><div class="next-post pull-right"><a href="/2020/12/25/Jetpack%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B8%89ViewModel%E8%A7%A3%E6%9E%90/"><img class="next-cover" data-lazy-src="https://developer.android.com/images/topic/libraries/architecture/viewmodel-lifecycle.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Jetpack源码解析（三）：ViewModel解析</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></article></main><footer id="footer" style="background-image: url(/2020/12/31/Jetpack%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E5%9B%9BDataBinding%E8%A7%A3%E6%9E%90/image-20210103190946285.png)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By @caoyangim</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/medium-zoom/dist/medium-zoom.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk({
      clientID: '86ddb46a1a64e44e8d85',
      clientSecret: 'c8b34ff31ea94ad0d21aa04353684e77f2bcfa79',
      repo: 'gitalk_comments',
      owner: 'caoyangim',
      admin: ['caoyangim'],
      id: '012ae792e66d164adda4a2e878c0cd10',
      language: 'zh-CN',
      perPage: 10,
      distractionFreeMode: true,
      pagerDirection: 'last',
      createIssueManually: true,
      updateCountCallback: commentCount
    })
    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    $.getScript('https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js', initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script defer="defer" id="ribbon_piao" mobile="false" src="/js/third-party/piao.js"></script><script src="/js/third-party/click_heart.js" async="async"></script><script src="/js/third-party/ClickShowText.js" async="async"></script></div></body></html>